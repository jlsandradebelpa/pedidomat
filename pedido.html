<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitação de Material</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>Solicitação de Material</h1>

        <!-- Abas -->
        <div class="tabs">
            <button onclick="openTab('geral')">Geral</button>
            <button onclick="openTab('materiaisTab')">Materiais</button>            
        </div>

        <!-- Aba Geral -->
        <div id="geral" class="tab-content active">
            <!-- Formulário Geral -->
            <div class="form-group">
                <!-- Seleção de Contrato e matrícula -->
                <div class="form-row">
                    <div class="form-element">
                        <label for="contract">Contrato</label>
                        <select id="contract" onchange="loadMaterials()">
                            <!-- <option value="linha_viva">Linha Viva</option> -->
                            <!-- <option value="linha_morta">Linha Morta</option> -->
                            <option value="corte">Corte</option>
                        </select>
                    </div>

                    <div class="form-element">
                        <label for="grupo">Grupo</label>
                        <select id="grupo" onchange="loadMaterials()">
                            <option value="EPC">EPC</option>
                            <option value="EPI">EPI</option>
                        </select>
                    </div>                    

                    <div class="form-element">
                        <label for="matricula">Matrícula</label>
                        <input type="text" id="matricula" placeholder="Informe sua matrícula">
                    </div>
                </div>

                <div class="form-element">
                    <label for="totalAdded">Qtde materiais solicitados</label>
                    <span id="totalAdded" class="total-quantity">0</span>
                </div>


            </div>
        </div>

        <!-- Aba Materiais -->
        <div id="materiaisTab" class="tab-content">
            <div class="form-row">
                <div class="form-element">
                    <input type="text" id="search" class="input-large" placeholder="Pesquisar material" maxlength="100" oninput="handleInput()">
                </div>
            </div>

            <!-- Lista de Materiais -->
            <div id="materialList" class="material-list">
                <!-- Lista de materiais será carregada aqui -->
            </div>
        </div>

        <!-- Visualização do Pedido -->
        <!-- <div id="pedidoView" class="tab-content" style="display:none;"> -->
            <!-- A visualização do pedido será gerada aqui -->
        <!-- </div> -->

        <!-- Ações -->
        <div class="actions">
            <button onclick="window.location.href='index.html'" class="back">Voltar ao Menu</button>
            <button onclick="finalizeRequest()" class="finalize">Finalizar Solicitação</button>
            <button onclick="zerarContador()" class="finalize">Limpar seleção</button>
        </div>
    </div>

    <!-- Frame de Informações Adicionais 
    <div id="addInfoFrame" class="add-info-frame" style="display:none;">
        <h3>Informações Adicionais</h3>
        <div class="form-element">
            <label for="motivo">Motivo</label>
            <select id="motivo">
                <option value="perda">1 - Perda</option>
                <option value="troca">2 - Troca por desgaste</option>
                <option value="roubo">3 - Roubo ou Furto</option>
                <option value="incremento">4 - Incremento</option>
            </select>
        </div>
  
        <div class="form-element">
            <label for="gallery">Acessar Galeria</label>
            <input type="file" id="gallery" accept="image/*">
        </div>

        <div class="form-element">
            <button onclick="capturePhoto()">Tirar Foto</button>
        </div>

        <div class="form-element">
            <button onclick="closeAddInfoFrame()">Fechar</button>
        </div>
    </div>
    -->

    <script>
        let materials = [];
        let selectedMaterials = JSON.parse(localStorage.getItem('selectedMaterials')) || {};
        let pedidoCounter = 1;

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.getElementById(tabName).style.display = 'block';
        }

        function loadMaterials() {
            const contract = document.getElementById('contract').value;
            const grupo = document.getElementById('grupo').value.toLowerCase();

            //const fileName = contract === 'linha_viva' ? 'linha_viva.json' : 'linha_morta.json';
            let fileName = '';

            if (contract === 'corte') {
                if (grupo === 'epi') {
                    fileName = 'corte_epi.json';
                }else if (grupo === 'epc') {
                    fileName = 'corte_epc.json';
                } else {
                    console.error('Grupo não reconhecido:', contract);
                    return;
                }
            } else {
                console.error('Contrato não reconhecido:', contract);
                return;                
            }
           

            fetch(fileName)
                .then(response => response.json())
                .then(data => {
                    materials = data;
                    filterMaterials();
                })
                .catch(error => {
                    console.error('Erro ao carregar o arquivo JSON:', error);
                });
        }

        function openTab(tabName) {
            // Oculta todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostra a aba selecionada
            document.getElementById(tabName).classList.add('active');
        }


        function displayMaterials(filteredMaterials) {
            const materialList = document.getElementById('materialList');
            materialList.innerHTML = '';
            filteredMaterials.forEach(material => {
                let div = document.createElement('div');
                let descricaoTruncada = material.descricao.substring(0, 54);
                div.classList.add('material-item');
                div.innerHTML = `
                    <span class="material-item">${material.codigo} - ${descricaoTruncada}</span>
                    <input id="qtd-${material.codigo}" type="text" placeholder="Qtd" class="qtd-input" oninput="validateNumber(this)">
                    <button onclick="addMaterial('${material.codigo}', '${material.descricao}')" class="button-add"><img src="concluido.png" alt="Concluído" />
                    <button onclick="removeMaterial('${material.codigo}')" class="button-remove"><img src="cancelar.png" alt="Cancelar" />
                    `;
                materialList.appendChild(div);
            });
        }

        function addMaterial(codigo, descricao) {
            const quantityInput = document.getElementById(`qtd-${codigo}`);
            const quantity = parseInt(quantityInput.value, 10);

            if (quantity > 0) {
                if (selectedMaterials[codigo]) {
                    selectedMaterials[codigo].quantity += quantity;
                } else {
                    selectedMaterials[codigo] = { descricao, quantity };
                }

                localStorage.setItem('selectedMaterials', JSON.stringify(selectedMaterials));
                updateTotalQuantity();

                // Exibe uma mensagem de confirmação
                alert(`Material "${descricao}" com a quantidade ${quantity} foi confirmado na lista.`);
            } else {
                alert('Por favor, insira uma quantidade válida.');
            }
        }

        function removeMaterial(codigo) {
            const quantityInput = document.getElementById(`qtd-${codigo}`);
            const quantity = parseInt(quantityInput.value, 10);

            if (selectedMaterials[codigo]) {
                if (quantity > 0) {
                    if (selectedMaterials[codigo].quantity > quantity) {
                        selectedMaterials[codigo].quantity -= quantity;
                    } else {
                        delete selectedMaterials[codigo];
                    }
                    localStorage.setItem('selectedMaterials', JSON.stringify(selectedMaterials));
                    updateTotalQuantity();

                    // Exibe uma mensagem de confirmação
                    alert(`Material "${descricao}" com a quantidade ${quantity} retirada da lista.`);
                } else {
                    alert('Faltando a qtde.');
                }
            } else {
                alert('Material não encontrado na lista.');
            }
        }

        function filterMaterials() {
            const searchValue = document.getElementById('search').value.toUpperCase();
            const filteredMaterials = materials.filter(material => 
                material.descricao.toUpperCase().includes(searchValue)
            );
            displayMaterials(filteredMaterials);
        }

        function convertToUppercase() {
            const searchInput = document.getElementById('search');
            searchInput.value = searchInput.value.toUpperCase();
        }

        function handleInput() {
            convertToUppercase();
            filterMaterials();
        }

        /*
        function updateTotalQuantity() {
            const totalQuantity = Object.values(selectedMaterials).reduce((total, item) => total + item.quantity, 0);
            document.getElementById('totalAdded').textContent = totalQuantity;
        }
        */
        function updateTotalQuantity() {
            const totalQuantity = Object.values(selectedMaterials).reduce((total, item) => {
                // Converte a quantidade para número antes de somar
                const quantity = parseInt(item.quantity, 10);
                return total + (isNaN(quantity) ? 0 : quantity);
            }, 0);

            document.getElementById('totalAdded').textContent = totalQuantity;
        }

        function finalizeRequest() {
            const matricula = document.getElementById('matricula').value;
            const grupo = document.getElementById('grupo').value;
            const contract = document.getElementById('contract').value;

            if (!matricula) {
                alert('Por favor, preencha o campo Matrícula.');
                document.getElementById('matricula').focus();
                return;
            }

            if (Object.keys(selectedMaterials).length === 0 || !matricula) {
                alert('Nenhum material foi selecionado ou matrícula não informada.');
                return;
            }

            const now = new Date();
            const timestamp = now.getFullYear().toString() +
                            (now.getMonth() + 1).toString().padStart(2, '0') +
                            now.getDate().toString().padStart(2, '0') + "_" +
                            now.getHours().toString().padStart(2, '0') +
                            now.getMinutes().toString().padStart(2, '0') +
                            now.getSeconds().toString().padStart(2, '0');
            const pedidoNumber = pedidoCounter++;
            const fileName = `ped${matricula}_${timestamp}.json`;
            const pedidoData = {
                numero_pedido: pedidoNumber,
                matricula,
                grupo,
                contrato: contract,
                materiais: selectedMaterials
            };

            let pedidoMensagem = `Solicitação de Material #${pedidoData.numero_pedido}\n`;
            pedidoMensagem += `Matrícula: ${pedidoData.matricula}\n`;
            pedidoMensagem += `Grupo: ${pedidoData.grupo}\n`;
            pedidoMensagem += `Contrato: ${pedidoData.contrato}\n`;
            pedidoMensagem += 'Materiais:\n';
            for (const codigo in pedidoData.materiais) {
                const item = pedidoData.materiais[codigo];
                pedidoMensagem += `- ${item.descricao}: ${item.quantity} unidade(s)\n`;
            }

            const encodedMessage = encodeURIComponent(pedidoMensagem);
            const whatsappNumber = '5591992069559';
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;

            const pedidoBlob = new Blob([JSON.stringify(pedidoData, null, 2)], { type: 'application/json' });
            const pedidoUrl = URL.createObjectURL(pedidoBlob);
            const downloadLink = document.createElement('a');
            downloadLink.href = pedidoUrl;
            downloadLink.download = fileName;
            downloadLink.click();

            window.open(whatsappUrl, '_blank');
        }

        function validateNumber(input) {
            const value = input.value;

            // Verifica se o valor contém apenas dígitos
            if (!/^\d*$/.test(value)) {
                input.value = value.replace(/\D/g, ''); // Remove todos os caracteres que não são números
            }
        }

        function zerarContador() {
            selectedMaterials = {};
            localStorage.setItem('selectedMaterials', JSON.stringify(selectedMaterials));
            updateTotalQuantity();
        }

        // Carregar materiais ao abrir a página
        loadMaterials();


        /*
        function openAddInfoFrame() {
            document.getElementById('addInfoFrame').style.display = 'block';
        }

        function closeAddInfoFrame() {
            document.getElementById('addInfoFrame').style.display = 'none';
        }

        function capturePhoto() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        const video = document.createElement('video');
                        video.srcObject = stream;
                        video.play();

                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);

                        const photoUrl = canvas.toDataURL('image/png');
                        const downloadLink = document.createElement('a');
                        downloadLink.href = photoUrl;
                        downloadLink.download = 'captured_image.png';
                        downloadLink.click();
                    })
                    .catch(error => {
                        console.error('Erro ao acessar a câmera:', error);
                        alert('Não foi possível acessar a câmera.');
                    });
            } else {
                alert('Câmera não disponível no seu dispositivo.');
            }
        }
        */
    </script>
</body>
</html>