<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido de Material</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container">
        <h1>Pedido de Material</h1>

        <!-- Formulário -->
        <div class="form-group">
            <!-- Seleção de Contrato e matrícula -->
            <div class="form-row">
                <div class="form-element">
                    <label for="contract">Contrato</label>
                    <select id="contract" onchange="loadMaterials()">
                        <option value="linha_viva">Linha Viva</option>
                        <option value="linha_morta">Linha Morta</option>
                    </select>
                </div>

                <div class="form-element">
                    <label for="matricula">Matrícula</label>
                    <input type="text" id="matricula" placeholder="Informe sua matrícula">
                </div>
            </div>

            <!-- Função e Total Adicionado -->
            <div class="form-row">
                <div class="form-element">
                    <label for="funcao">Função</label>
                    <select id="funcao">
                        <option value="encarregado">Encarregado</option>
                        <option value="eletricista">Eletricista</option>
                    </select>
                </div>

                <div class="form-element total-added-container">
                    <label class="total-added-label">Materiais :</label>
                    <div class="total-added">
                        <span id="totalAdded" class="total-added-value">0</span>
                    </div>
                </div>
            </div>
                
            <!-- Pesquisa -->
            <div class="form-row">
                <div class="form-element">
                    <input type="text" id="search" placeholder="Pesquisar material" maxlength="100" oninput="handleInput()">
                </div>
            </div>
            
        </div>

        <!-- Lista de Materiais -->
        <div id="materialList" class="material-list">
            <!-- Lista de materiais será carregada aqui -->
        </div>

        <!-- Ações -->
        <div class="actions">
            <button onclick="window.location.href='index.html'" class="back">Voltar ao Menu</button>
            <button onclick="finalizeRequest()" class="finalize">Finalizar Solicitação</button>
        </div>

        <!-- Visualização do Pedido -->
        <div id="pedidoView" class="pedido-view" style="display:none;">
            <!-- A visualização do pedido será gerada aqui -->
        </div>
    </div>

    <script>
        let materials = [];
        let selectedMaterials = JSON.parse(localStorage.getItem('selectedMaterials')) || {};
        let pedidoCounter = 1; // Para fins de exemplo, começando com um número fixo de pedido

        function loadMaterials() {
            const contract = document.getElementById('contract').value;
            const fileName = contract === 'linha_viva' ? 'linha_viva.json' : 'linha_morta.json';

            fetch(fileName)
                .then(response => response.json())
                .then(data => {
                    materials = data;
                    filterMaterials(); // Atualiza a exibição após carregar os materiais
                })
                .catch(error => {
                    console.error('Erro ao carregar o arquivo JSON:', error);
                });
        }

        function displayMaterials(filteredMaterials) {
            const materialList = document.getElementById('materialList');
            materialList.innerHTML = '';
            filteredMaterials.forEach(material => {
                let div = document.createElement('div');

                // Truncando a descrição para 54 caracteres
                let descricaoTruncada = material.descricao.substring(0, 54);

                div.classList.add('material-item');
                div.innerHTML = `
                    <span class="material-item">${material.codigo} - ${descricaoTruncada}</span>
                    <input id="qtd-${material.codigo}" type="number" placeholder="Qtd" min="1" class="qtd-input">
                    <button onclick="addMaterial('${material.codigo}', '${material.descricao}')" class="button-add">+</button>
                    <button onclick="removeMaterial('${material.codigo}')" class="button-remove">-</button>
                    `;
                materialList.appendChild(div);
            });
        }

        function addMaterial(codigo, descricao) {
            const quantityInput = document.getElementById(`qtd-${codigo}`);
            const quantity = parseInt(quantityInput.value, 10);

            // Exibir o valor inicial da quantidade no console
            console.log(`acrescenta mais 1 ${codigo} (${descricao}): ${quantity}`);

            if (quantity > 0) {
                if (selectedMaterials[codigo]) {
                    selectedMaterials[codigo].quantity += quantity;
                } else {
                    selectedMaterials[codigo] = { descricao, quantity };
                }

                localStorage.setItem('selectedMaterials', JSON.stringify(selectedMaterials));
                updateTotalQuantity();
            } else {
                alert('Por favor, insira uma quantidade válida.');
            }
        }

        function removeMaterial(codigo) {
            const quantityInput = document.getElementById(`qtd-${codigo}`);
            const quantity = parseInt(quantityInput.value, 10);

            // Exibir o valor inicial da quantidade no console
            console.log(`Diminui 1 ${codigo} : ${quantity}`);

            if (selectedMaterials[codigo]) {
                if (quantity > 0) {
                    if (selectedMaterials[codigo].quantity > quantity) {
                        selectedMaterials[codigo].quantity -= quantity;
                    } else {
                        //selectedMaterials[codigo] = { descricao, quantity };
                        delete selectedMaterials[codigo];
                    }
                    localStorage.setItem('selectedMaterials', JSON.stringify(selectedMaterials));
                    updateTotalQuantity();
                } else {
                    alert('Faltando a qtde.');
                }
            } else {
                alert('Material não encontrado na lista.');
            }
        }
        
        function filterMaterials() {
            const searchValue = document.getElementById('search').value.toUpperCase();
            const filteredMaterials = materials.filter(material => 
                material.descricao.toUpperCase().includes(searchValue)
            );
            displayMaterials(filteredMaterials);
        }

        function convertToUppercase() {
            const searchInput = document.getElementById('search');
            searchInput.value = searchInput.value.toUpperCase();
        }

        function handleInput() {
            convertToUppercase();
            filterMaterials();
        }

        function updateTotalQuantity() {
            const totalQuantity = Object.values(selectedMaterials).reduce((total, item) => total + item.quantity, 0);
            document.getElementById('totalAdded').textContent = totalQuantity;
        }

        function finalizeRequest() {
            const matricula = document.getElementById('matricula').value;
            const funcao = document.getElementById('funcao').value;
            const contract = document.getElementById('contract').value;

            if (Object.keys(selectedMaterials).length === 0 || !matricula) {
                alert('Nenhum material foi selecionado ou matrícula não informada.');
                return;
            }

            const now = new Date();
            const timestamp = now.getFullYear().toString() +
                              (now.getMonth() + 1).toString().padStart(2, '0') +
                              now.getDate().toString().padStart(2, '0') + "_" +
                              now.getHours().toString().padStart(2, '0') +
                              now.getMinutes().toString().padStart(2, '0') +
                              now.getSeconds().toString().padStart(2, '0');
            const pedidoNumber = pedidoCounter++; // Incrementa o número do pedido
            const fileName = `ped${matricula}_${timestamp}.json`;
            const pedidoData = {
                numero_pedido: pedidoNumber,
                matricula,
                funcao,
                contrato: contract,
                materiais: selectedMaterials
            };

            // Gerar e baixar o arquivo JSON
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(pedidoData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode); 
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            // Exibir a visualização do pedido
            displayPedidoView(pedidoData);

            localStorage.removeItem('selectedMaterials');
            selectedMaterials = {};
            updateTotalQuantity();
            alert('Solicitação finalizada com sucesso!');
        }

        function displayPedidoView(pedidoData) {
            const pedidoView = document.getElementById('pedidoView');
            pedidoView.style.display = 'block';
            pedidoView.innerHTML = `
                <h2>Pedido de Material #${pedidoData.numero_pedido}</h2>
                <p><strong>Contrato:</strong> ${pedidoData.contrato}</p>
                <p><strong>Função:</strong> ${pedidoData.funcao}</p>
                <p><strong>Matrícula:</strong> ${pedidoData.matricula}</p>
                <h3>Materiais Selecionados:</h3>
                <ul>
                    ${Object.entries(pedidoData.materiais).map(([codigo, item]) => 
                        `<li>${item.descricao}: ${item.quantity}</li>`
                    ).join('')}
                </ul>
            `;
        }

        // Carregar materiais ao abrir a página
        loadMaterials();
    </script>

</body>
</html>